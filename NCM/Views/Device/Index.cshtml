@model IEnumerable<NCM.Models.Device>

@{
    ViewData["Title"] = "Devices List";
}

<h1>Devices</h1>

<p>
    <a asp-action="Create" class="btn btn-success">Create New Device</a>
</p>

<table class="table table-striped">
    <thead>
        <tr>
            <th>@Html.DisplayNameFor(model => model.Name)</th>
            <th>@Html.DisplayNameFor(model => model.IPAddress)</th>
            <th>@Html.DisplayNameFor(model => model.Type)</th>
            <th>@Html.DisplayNameFor(model => model.Status)</th>
            <th>@Html.DisplayNameFor(model => model.LastBackupTime)</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.Name</td>
                <td>@item.IPAddress</td>
                <td>@item.Type</td>
                <td>@(item.Status ? "Online" : "Offline")</td>
                <td>@(item.LastBackupTime.HasValue ? item.LastBackupTime.Value.ToString("g") : "N/A")</td>
                <td>
                    <a asp-action="Details" asp-route-id="@item.DeviceId">Details</a>
                    <text> | </text>
                    <a asp-action="Edit" asp-route-id="@item.DeviceId">Edit</a>
                    <text> | </text>
                    <a asp-action="Delete" asp-route-id="@item.DeviceId">Delete</a>

                    @{
                        var configs = item.DeviceConfigs.OrderByDescending(c => c.UploadTime).ToList();
                        if (configs.Count > 1)
                        {
                            var latest = configs[0];
                            var previous = configs[1];
                        }
                    }
                    @if (item.DeviceConfigs.Count() > 1)
                    {
                        var cfgs = item.DeviceConfigs.OrderByDescending(c => c.UploadTime).ToList();
                        var latestCfg = cfgs[0];
                        var prevCfg = cfgs[1];
                        <text> | </text>
                        <a asp-action="Diff" asp-route-id="@latestCfg.ConfigId" asp-route-oldId="@prevCfg.ConfigId">Diff</a>
                        <text> | </text>
                        <a asp-action="ComplianceResults" asp-route-id="@latestCfg.ConfigId">Compliance</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
